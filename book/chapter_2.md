# chapter 2  实现 SLOs

服务级别目标(SLOs)为服务的可靠性指定一个目标级别。因为SLOs是关于可靠性的数据驱动决策的关键，所以它们是SRE实践的核心。从很多方面来说，这是本书最重要的一章。

一旦您具备了一些指导原则，就可以直接设置初始SLOs和细化它们的过程。第4章介绍了SLOs和SLIs (service level indicators，服务水平指标)的主题，并就如何使用给出了一些建议。

在讨论了SLOs背后的动机和错误预算之后，本章提供了一个循序渐进的方法来帮助您开始思考 SLOs，以及一些关于如何从那里迭代的建议。然后我们将介绍如何使用SLOs来做出有效的业务决策，并探讨一些高级主题。最后，我们将为您提供一些用于不同类型服务的 SLOs 示例，以及一些关于如何在特定情况下创建更复杂 SLOs 的方针。<sup>1</sup>

> 1 关于术语的注意事项:在本章中，我们使用可靠性这个词来讨论服务在所有 SLIs 方面的执行情况。这可以指示许多事情，例如可用性或延迟。

## 为什么 SREs 需要 SLOs

即使在最大的组织中，工程师也是一种稀缺的资源。工程时间应该投资在最重要的特征最重要的服务上。在投资于能够赢得新客户或保留现有客户的功能和投资于能够让这些客户满意的可靠性和可伸缩性之间取得适当的平衡是困难的。在谷歌，我们了解到，一个经过深思熟虑并采用的SLO是关于可靠性工作的机会成本做出基于数据的决策，以及确定如何适当地对该工作进行优先排序的关键。

SREs 的核心职责不仅仅是实现“所有事情”的自动化和手持寻呼机。它们的日常任务和项目由 SLOs 驱动:确保 SLOs 在短期内得到保护，并且可以在中长期内得到维护。甚至可以说，没有 SLOs，就不需要 SREs。

SLOs是一种工具，可以帮助确定工程工作的优先级。例如，考虑两个可靠性项目的工程权衡:自动回滚和迁移到可复制的数据存储。通过计算对错误预算的估计影响，我们可以确定哪个项目对用户最有利。参见第37页的“使用SLOs和错误预算进行决策”一节，了解更多关于此的细节，以及站点可靠性工程中的“风险管理”。

## 开始

作为建立一组基本 SLOs 的起点，让我们假设您的服务是某种已编译和发布的代码，并且运行在用户通过 web 访问的网络基础设施上。您的系统的成熟度级别可能是以下级别之一:

- 一个新开发的领域，目前没有部署任何东西

- 在生产环境中，有一些监控系统，当出现问题时通知您，但是没有正式的目标，没有错误预算的概念，也没有100%正常运行时间的默认目标

- 在 SLO 低于 100% 的情况下运行的部署，但是对于其重要性或如何利用它进行持续改进的选择没有一个共同的理解——换句话说，一个没有牙齿的 SLO。

为了采用基于错误预算的方法进行现场可靠性工程，您需要达到以下状态:

- 组织中的所有涉众都批准了适合产品的 SLOs。

- 负责确保服务符合其SLO的人员同意，在正常情况下有可能符合该 SLO。

- 组织已经承诺将错误预算用于决策和优先级排序。这一承诺在错误预算政策中得到正式体现。

- 有一个提炼 SLO 的过程。

否则，您将无法采用基于错误预算的可靠性方法。SLO 遵从性将仅仅是另一个 KPI (关键性能指标)或报告度量，而不是决策工具。

### 可靠性目标和错误预算

制定适当的 SLOs 的第一步是讨论什么是 SLO，以及它应该包括什么。

SLO 为服务的客户设置了一个可靠的目标级别。在此阈值之上，几乎所有用户都应该对您的服务感到满意(假设他们对服务的实用程序感到满意)<sup>2</sup>。在这个阈值以下，用户可能会开始抱怨或停止使用该服务。最终，用户的快乐才是最重要的——快乐的用户使用服务，为您的组织创造收入，对客户支持团队提出低要求，并向他们的朋友推荐服务。我们以可靠的服务使顾客满意。

顾客幸福感是一个相当模糊的概念;我们不能精确地测量它。通常我们对它的了解很少，那么我们该如何开始呢?第一个 SLO 使用什么?

我们的经验表明，100% 的可靠性是错误的目标。

- 如果您的 SLO 与客户满意度一致，那么100%不是一个合理的目标。即使使用冗余组件、自动健康检查和快速故障转移，一个或多个组件同时失败的概率也不为零，从而导致不足 100% 的可用性。

- 即使您可以在系统中实现 100% 的可靠性，您的客户也不会体验到 100% 的可靠性。您和您的客户之间的系统链通常又长又复杂，这些组件中的任何一个都可能失败。<sup>3</sup>这也意味着，当可靠性从 99% 提高到 99.9% 再提高到 99.99% 时，每增加 9 个，成本就会增加，但客户的边际效用会稳步接近于零。

- 如果你设法为你的客户创造一种 100% 可靠的体验，并且想要保持这种可靠程度，你就永远无法更新或改进你的服务。停机的首要原因是更改:推出新功能、应用安全补丁、部署新硬件，以及扩大规模以满足客户需求，这些都将影响到100%的目标。迟早，你的服务将停滞不前，你的客户将转向别处，这对任何人的底线都不是好事。

- SLO 为 100% 意味着您只有时间进行响应。除了对 < 100% 可用性(这是肯定会发生的)作出反应之外，您实际上不能做任何其他事情。100% 的可靠性不是一种工程文化，而是一种运维文化。

- 一旦您的 SLO 目标低于 100%，这就需要组织中有权在特性速度和可靠性之间进行权衡的人员。在小型组织中，这可能是 CTO，在较大的组织中，通常是产品所有者（或产品经理）。

> 2 这与服务水平协议(service level agreement, SLA)不同，后者是一种业务契约，当用户非常不高兴时，您必须以某种方式对其进行补偿。

> 3 有关将依赖关系分解为服务可靠性的更多细节，请参见本·特赖诺、迈克·达林、维维克·劳和贝茜·拜尔的《服务可用性的计算》，ACM队列15，第15号。2 (2017)， https:// queue.acm.org/detail.cfm?id=3096459。 

### 怎么来衡量：使用 SLIs（服务水平指标）

一旦你同意100%是错误的数字，你如何确定正确的数字?你到底在测量什么?这里，服务水平指示器开始发挥作用:SLI 是您所提供服务水平的指示器。

虽然很多数字都可以作为 SLI。我们通常建议将两个数字的比值作为 SLI：好的事件除以事件的总数。例如：

- HTTP请求成功次数/ HTTP请求总数(成功率)

- < 100 ms / total gRPC请求中成功完成的gRPC调用数

- 使用整个语料库的搜索结果的数量/搜索结果的总数，包括那些优雅地降级的搜索结果

- 产品搜索中使用的库存数据更新时间超过10分钟的“库存盘点”请求数量/库存盘点请求总数

- 根据该度量标准的扩展标准列表，“良好用户分钟”的数量/总用户分钟数

这种形式的 SLIs 具有几个特别有用的属性。SLI 范围从 0% 到100%，0% 表示什么都不行，100% 表示什么都没有损坏。我们发现这个比例很直观，而且这种风格很容易引入错误预算的概念:SLO 是一个目标百分比，错误预算是 100% 减去 SLO。例如，如果您有 99.9% 的成功率 SLO，那么在四周时间内接收 300 万请求的服务在此期间的预算错误为 3000(0.1%)。如果一次停机造成 1500 个错误，那么该错误将花费错误预算的 50%。<sup>4</sup>

> 4 如果你在一个日历周期(比如四分之一年)内测量你的SLO，那么如果你的预算是基于不可预测的指标(比如流量)，那么你可能不知道在这个季度末你的预算会有多大。有关报告期间的更多讨论，请参阅第29页的“选择适当的时间窗口”。

此外，使所有的 SLIs 遵循一致的风格可以更好地利用工具:您可以编写警报逻辑、SLO 分析工具、错误预算计算和报告，以期望得到相同的输入:分子、分母和阈值。简化是这里的一个好处。

当您第一次尝试制定 SLIs 时，您可能会发现将 SLIs 进一步划分为 SLI 规范和 SLI 实现是非常有用的。

*SLI 规范*
    
与如何测量无关，你认为服务结果的评估对用户很重要

例如：载入事件小于 100ms 的主页请求的比率

*SLI 实现*

规范 SLI 及测量它的方法。

例如：

- 从服务器日志的延迟这一列指标测量的以< 100 ms装载的主页请求的比率。此度量将错过未能到达后端的请求。

- 加载在< 100毫秒内的主页请求的比率，由在虚拟机中运行的浏览器中执行JavaScript的探测程序测量。当请求无法到达我们的网络时，这种度量将捕获错误，但是可能会遗漏只影响一部分用户的问题。

- 加载在< 100ms内的主页请求的比率，通过在主页本身的JavaScript中的检测来衡量，并报告给专用的遥测记录服务。这种度量将更准确地捕获用户体验，尽管我们现在需要修改代码来捕获这些信息，并构建基础设施来记录它——这是一种具有自身可靠性需求的规范。

正如您所看到的，一个规范可能有多个 SLI 实现，每个实现在质量(它们捕获客户体验的精确性)、覆盖率(它们捕获所有客户体验的精确性)和成本方面都有自己的优缺点。

你对 SLI 和 SLO 的第一次尝试不一定是正确的;最重要的目标是让一些东西到位并得到衡量，并建立一个反馈循环，这样你就可以改进。(我们在第34页的“SLO目标的持续改进”中对此主题进行了更深入的探讨。)

在我们的第一本书中，我们建议不要基于当前的性能选择一个 SLO，因为这会使您陷入不必要的严格的SLOs。虽然这个建议是正确的，但是如果您没有任何其他信息，并且您有一个很好的迭代过程(我们将在稍后介绍)，那么您当前的性能可能是一个很好的起点。然而,不要让当前的性能限制你完善你的 SLO:你的客户也会期待你的服务来执行 SLO,所以如果你的服务返回成功请求 99.999% 的时间不到 10ms,任何从基线重要的回归可能让他们不开心。

为了创建您的第一组 SLOs，您需要决定一些与您的服务相关的关键 SLI 规范。可用性和延迟 SLOs 是很常见的：新鲜度、持久性、正确性、质量和覆盖率 SLOs 也有它们的位置(稍后我们将详细讨论这些)。

如果您在确定从哪种类型的 SLI 开始时有困难，那么从简单的开始会有所帮助:

- 选择要为其定义SLOs的应用程序。如果您的产品包含许多应用程序，您可以稍后添加这些应用程序。

- 弄清楚这种情况下谁是真正的用户，这些人很乐于看到你这在优化。

- 考虑用户和系统常见任务和关键活动交互的通常方式

- 绘制系统的高层架构图;显示关键组件、请求流、数据流和关键依赖项。将这些组件分组到下一节列出的类别中(可能存在一些重叠和歧义;运用你的直觉，不要让完美成为好的敌人。

您应该仔细考虑选择什么作为您的 SLIs，但也不应该将事情复杂化。特别是当您刚刚开始您的 SLI 之旅时，请选择一个与您的系统相关但易于度量的方面—您总是可以在稍后进行迭代和改进。

#### 组件的类型

开始设置 SLIs 最简单的方法是将系统抽象为几种常见类型的组件。然后，您可以使用我们为每个组件提供的建议 SLIs 列表，选择与您的服务最相关的组件:

*需求驱动*

用户创建某种类型的事件并期望得到响应。例如，这可以是一个HTTP服务，用户可以在其中与浏览器或移动应用程序的API交互。

*管道*

将记录作为输入、对记录进行改变并将输出放到其他地方的系统。这可能是一个实时运行在单个实例上的简单进程，也可能是一个耗时数小时的多阶段批处理进程。例子包括：

- 一种定期从关系数据库中读取数据并将其写入分布式哈希表以便优化服务的系统

- 一种视频处理服务，将视频从一种格式转换为另一种格式

- 从多个源读取日志文件以生成报告的系统

- 从远程服务器获取指标并生成时间序列和警报的监视系统

*存储*

一种接受数据(如字节、记录、文件、视频)并使之在以后能够被检索的系统。

## 一个生动的例子

考虑一个简化的手机游戏架构，如图2-1所示。

![image](/book/figure/Figure2-1.png)
图 2-1.以手机游戏架构为例

运行在用户手机上的应用程序与运行在云中的 HTTP API 交互。API 将状态更改写入永久存储系统。一个管道定期运行这些数据，生成今天、本周和所有时间的高分排行榜。这些数据被写入一个单独的联赛表数据存储区，结果可以通过移动应用程序(游戏内得分)和网站获得。用户可以通过 API 和高分网站将游戏中使用的自定义头像上传至用户数据表。

有了这个设置，我们可以开始考虑用户如何与系统交互，以及什么样的 SLIs 将度量用户体验的各个方面。

其中一些 SLIs 可能会重叠:请求驱动的服务可能具有正确性的 SLI，管道可能具有可用性的 SLI，持久性的 SLIs 可能被视为正确性的 SLIs 的变体。我们建议选择少量(5个或更少)的 SLI 类型，这些类型对您的客户来说是最关键的功能。

为了捕捉典型的用户体验和长尾效应，我们还建议对某些类型的SLIs使用多个级别的SLOs。例如，如果 90% 的用户请求在 100 毫秒内返回，而剩下的 10% 需要 10 秒，许多用户会不高兴。延迟指标 SLO 可以通过设置多个阈值来捕获这个用户群: 90% 的请求速度超过 100 ms, 99% 的请求速度超过 400 ms。这个原则适用于所有带有测量用户不愉快程度参数的 SLIs。

表 2-1 提供了不同服务类型的常见的 SLIs。

*表 2-1 不同类型组件的潜在 SLIs*

![image](/book/figure/Table2-1.png)
![image](/book/figure/Table2-1(2).png)

### 从 SLI 规范转移到 SLI 实现

现在我们已经知道了SLI规范，我们需要开始考虑如何实现它们。

对于您的第一个 SLIs，选择一些需要最少工程工作的东西。如果您的 web 服务器日志已经可用，但是设置探测将花费数周时间，插装 JavaScript 将花费数月时间，那么就使用这些日志。

你需要足够的信息来测量 SLI：对于可用性，你需要成功/失败状态；对于慢请求，您需要花费时间来响应请求。您可能需要重新配置 web 服务器来记录这些信息。如果您使用的是基于云的服务，其中一些信息可能已经可以在在监控仪表盘中获取到。

对于我们的示例体系结构，有许多针对SLI实现的选项，每个选项都有其优缺点。下面几节将详细介绍系统中三种类型组件的 SLIs。

#### API 和 HTTP 服务器的可用性和延迟

对于所有考虑到的 SLI 实现，我们将响应成功建立在 HTTP 状态代码的基础上。对于 SLO 来说，5XX 是失败的，而所有其他请求都被认为是成功的。我们的可用性 SLI 是成功请求的比例，延迟 SLIs 是超过定义阈值的请求的比例。

您的 SLIs 应该是具体的、可度量的。要总结在第 20 页的“测量内容：使用 SLIs”中提供的潜在候选项列表，您的 SLIs 可以使用以下一个或多个资源：

- 应用程序服务器日志
- 负载均衡器监控
- 黑盒监控
- 客户端工具

我们的示例使用负载均衡器监控，因为度量标准已经可用，并且提供的 SLIs 比来自应用服务器日志的更接近用户体验。

#### 管道的新鲜度、覆盖率和正确性

当我们的管道更新联赛表时，它会记录一个包含数据更新时间戳的水印。一些特殊 SLI 实现的例子:

- 在联赛表上运行定期查询，计算新记录的总数和记录的总数。不管有多少用户看到数据，这都将把每条旧记录视为同等重要。

- 让联赛表的所有客户端在请求新数据时检查水印，并增加一个表示数据已经被请求过的度量计数器。如果数据比预定义阈值更新，则增加另一个计数器。

从这两个选项中，我们的示例使用客户端实现，因为它提供了与用户体验密切相关且易于添加的 SLIs。

为了计算我们的覆盖率 SLI，我们的管道导出它应该处理的记录数量和成功处理的记录数量。由于配置错误，这个度量可能会丢失管道不知道的记录。

我们有一些潜在的方法来测量正确性：

- 将具有已知输出的数据注入系统，并计算输出与预期匹配的次数的比例。

- 使用一种方法，根据与管道本身不同的输入计算正确的输出(而且可能更昂贵，因此不适合管道)。用它来采样输入/输出对，并计算正确输出记录的比例。这种方法假定创建这样一个系统是可能的和实际的。

我们的示例基于游戏状态数据库中一些手工整理的数据，这些数据具有每次管道运行时都要测试的良好输出。我们的 SLI 是正确输入测试数据的比例。为了使此 SLI 能够代表实际的用户体验，我们需要确保手动策划的数据能够代表实际数据。

### 测量 SLIs

图 2-2 显示了我们的白盒监控系统如何从示例应用程序的各个组件收集指标。

![image](/book/figure/Figure2-2.png)

图 2-2 我们的监控系统如何收集 SLI 指标

让我们看一个使用来自监视系统的指标来计算启动 SLOs 的示例。虽然我们的示例使用可用性和延迟指标，但相同的原则适用于所有其他潜在的 SLOs。有关系统使用的度量标准的完整列表，请参见附录 a。我们的所有示例都使用[普罗米修斯表示法](https://prometheus.io/)。

#### 负载均衡器的指标

后端("api" 或 "web")请求总数和相应代码：

```
http_requests_total{host="api", status="500"}
```

总延迟，作为累积直方图；每个柱子计算花费少于或者等于改时间的请求数量：

```
http_request_duration_seconds{host="api", le="0.1"}
http_request_duration_seconds{host="api", le="0.2"}
http_request_duration_seconds{host="api", le="0.4"}
```

一般来说，计算慢请求比用直方图近似它们要好。但是，由于这些信息获取不到，我们使用监视系统提供的直方图。另一种方法是根据负载均衡器配置中的各种慢度阈值(例如，100 ms和 500 ms的阈值)显式地慢请求计数。这种策略将提供更准确的数字，但需要更多的配置，这使得追溯更改阈值变得更加困难。

```
http_request_duration_seconds{host="api", le="0.1"}
http_request_duration_seconds{host="api", le="0.5"}
```

#### 计算 SLIs

使用前面的指标，我们可以计算过去七天的当前 SLIs，如表 2-2所示。

*表 2-2 前七天 SLIs 的计算结果*

![image](/book/figure/Table2-2.png)

### 使用 SLIs 计算启动指标 SLOs

我们可以将这些 SLIs 四舍五入到可管理的数字(例如，两个重要的可用性数字，或者最多 50ms<sup>5</sup> 的延迟)，以获得我们的启动指标 SLOs。

> 5 50毫秒，因为用户不太可能感觉到延迟有50毫秒的变化，但是适当的窗口显然取决于服务和用户。报告服务将不同于实时游戏。

例如，超过四周，API 指标显示：

- 总请求数: 3,663,253
- 成功请求总数: 3,557,865 (97.123%)
- 第 90 个百分位延迟: 432 毫秒
- 第 99 个百分位延迟: 891 毫秒

我们对其他 SLIs 重复了这个过程，并未 API 创建一个建议的 SLO，如表 2-3 所示。

*表 2-3 API 提议的 SLOs*

![image](/book/figure/Table2-3.png)

附录 A 提供了 SLO 文档的完整示例。本文档包括 SLI 实现，为了简单起见，我们在这里省略了这些实现。

根据这个提议的SLI，我们可以计算这四周的误差预算，如表 2-4 所示。

*表 2-4 前四周里的错误预算*

![image](/book/figure/Table2-4.png)


## 选择适当的时间窗口

SLOs 可以在不同的时间间隔内定义，可以使用滚动窗口或日历对齐窗口(例如，一个月)。在选择窗口时，需要考虑几个因素。

滚动窗口与用户体验更紧密地结合在一起：如果您在一个月的最后一天发生了一次大停机，您的用户不会在次月的第一天突然忘记它。我们建议将这段时间定义为周的整数，这样它总是包含相同数量的周末。例如，如果您使用 30 天的窗口，一些时段可能包括四个周末，而其他时段可能包括五个周末。如果周末的流量与工作日的流量有很大不同，那么您的 SLIs 可能会因为一些不有趣的原因而发生变化。

日历窗口与业务规划和项目工作更紧密地结合在一起。例如，您可以每个季度评估SLOs，以确定下一个季度的项目人员数量的重点。日历窗口还引入了一些不确定因素:在本季度中期，不可能知道在本季度剩余时间内会收到多少请求。因此，在季度中期做出的决策必须推测出在本季度余下的时间里，您将花费多少错误预算。

更短的时间窗口允许您更快地做出决策:如果您错过了前一周的 SLO，那么小的课程更正—例如，对相关bug进行优先排序—可以帮助您在未来几周避免违反 SLO。

更长的时间周期对于更具有战略性的决策是更好的:例如，如果您只能选择三个大型项目中的一个，那么迁移到高可用性分布式数据库、自动化您的推出和回滚过程、或者在另一个区域部署重复的堆栈会更好吗？你需要一周以上的数据来评估大型的多季度项目;所需的数据量与为修复它而提出的工程工作量大致相当。

我们发现一个四周滚动窗口是一个很好的通用间隔。我们用每周的任务优先级总结和每季的项目计划总结报告来补充这个时间框架。

如果数据源允许，那么您可以使用这个建议的 SLO 来计算您在这段时间内的实际SLO性能:如果您根据实际测量值设置初始 SLO，那么通过设计，您就满足了您的SLO。但是我们也可以收集关于分布的有趣信息。在过去的四个星期里，我们的服务有没有哪一天没有达到标准?这些日子与实际事件有关联吗?在那些日子里是否(或者是否应该)采取了一些行动来应对这些事件?

如果没有日志、指标或任何其他历史性能源，则需要配置数据源。例如，作为 HTTP 服务的低保真解决方案，您可以设置远程监控服务，该服务对服务执行某种定期健康检查(ping或HTTP GET)，并报告成功请求的数量。许多在线服务可以轻松实现此解决方案。

## 获得利益相关者的同意

为了使建议的 SLO 更有用、有效，你需要让所有参与者同意：

- 产品经理必须同意，这个阈值对于用户来说已经足够好了——低于这个值的性能低得令人无法接受，值得花费工程时间来修复

- 产品开发人员需要同意，如果错误预算已经用尽，他们将采取一些步骤来减少用户的风险，直到服务回到预算中(如“建立错误预算策略”中所讨论的)。

- 负责生产环境的团队负责维护这个 SLO，他们一致认为它是可以防御的，不需要付出巨大的努力，不需要付出过多的劳动，也不需要消耗大量的精力——所有这些都会损害团队和服务的长期健康。

一旦所有这些观点都达成一致，困难的部分就完成了<sup>6</sup>。您已经开始了您的 SLO 旅程，剩下的步骤需要从这个起点迭代。

为了保护您的 SLO，您需要设置监视和警报(参见第5章)，以便工程师在错误预算威胁成为赤字之前及时收到错误预算威胁的通知。

> 6 免责声明:未来可能会有更困难的任务

### 建立错误的预算政策

一旦您有了一个 SLO，您就可以使用这个 SLO 来获得一个错误预算。为了使用这个错误预算，您需要一个策略来概述当您的服务耗尽预算时应该做什么。

让所有关键利益相关者——产品经理、开发团队和 SREs ——批准错误预算策略，是测试 SLOs 是否适合目标的好方法：

- 如果 SREs 认为 SLO 在不付出过多劳动的情况下是站不住脚的，那么他们就有理由放松一些目标。

- 如果开发团队和产品经理认为他们必须投入更多的资源来修复可靠性，这会导致特性发布速度低于可接受的水平，那么他们也可以主张放松目标。请记住，降低 SLOs 还会降低 SREs 响应的情况的数量;产品经理需要理解这种权衡。

- 如果产品经理认为，在错误预算策略提示任何人解决问题之前，SLO 会给大量用户带来糟糕的体验，那么 SLOs 可能不够紧凑。

如果三方不同意执行错误预算策略，则需要在 SLIs 和 SLOs 上迭代，直到所有涉众都满意为止。决定如何前进，以及需要做哪些决定:更多的数据、更多的资源，还是对 SLI 或 SLO 的更改?

当我们谈到强制执行错误预算时，我们的意思是一旦您耗尽了错误预算(或接近耗尽它)，您应该做一些事情来恢复系统的稳定性。

要做出错误的预算执行决策，您需要从书面策略开始。此策略应涵盖在服务在给定时间内耗尽其全部错误预算时必须采取的具体行动，并指定谁将采取这些行动。一般所有者和行动可包括:

- 在过去的四周中，开发团队对与可靠性问题相关的 bug 给予了最高的优先级

- 开发团队只关注可靠性问题，直到系统在 SLO 监控指标下运行。这一职责得到高层的批准，可以对外部特性请求和任务进行回推。

- 为了减少更多停机的风险，生产冻结会停止对系统的某些更改，直到有足够的错误预算来恢复更改。

有时服务会消耗其全部错误预算，但并非所有涉众都认为制定错误预算策略是适当的。如果发生这种情况，您需要返回错误预算策略批准阶段。

### 记录 SLO 和错误预算策略

适当定义的 SLO 应该记录在显眼的位置，以便其他团队和涉众可以评审它。本文件应包括下列资料:

- SLO 的作者、审阅人员(检查它的技术准确性)和审批者(对它是否是正确的 SLO 作出业务决策)。

- 批准的日期，以及下次审查的日期。

- 对服务的简要描述，给读者提供上下文。

- SLO 的细节:目标和 SLI 实现。

- 错误预算如何计算和使用的详细信息。

- 这些数字背后的基本原理，以及它们是来自实验数据还是观察数据。即使 SLOs 是完全特别的，也应该记录这个事实，以便将来阅读文档的工程师不会基于特别的数据做出错误的决定。

您多久检查一次 SLO 文档取决于您的 SLO 文化的成熟度。开始时，您可能应该经常回顾 SLO —也许每个月都要回顾一次。一旦 SLO 变得更加合适，您就可以减少每个季度甚至更少的审查。

错误预算政策也应该记录在案，并且应该包括以下信息：

- 策略作者、审阅人员和批准人员

- 批准的日期，以及下次审查的日期

- 对服务的简要描述，给读者提供上下文

- 为应付预算耗尽而采取的行动

- 如果在计算上存在分歧，或商定的行动在这种情况下是否适当，应采取明确的升级途径

- 根据听众的错误预算经验和专业水平，包含错误预算的概述可能是有益的

有关SLO文档和错误预算策略的示例，请参见附录A。

### 仪表板和报告

除了已发布的 SLO 和错误预算策略文档之外，报告和指示板还可以提供服务的 SLO 合规性的实时快照，以便与其他团队进行通信并发现问题区域，这是非常有用的。

图 2-3 中的报告显示了几个服务的整体合规性：它们是否满足前一年的所有季度SLO（括号中的数字表示满足的目标数量，以及目标总数），以及他们的 SLI 是否相对于去年同期和去年同季呈上升趋势或下行趋势。

![image](/book/figure/Figure2-3.png)
图 2-3 SLO 合规性报告

指示板显示特殊语言障碍的趋势也很有用。这些指示板指示您是否正在以高于通常的速度消耗预算，或者是否存在需要注意的模式或趋势。

图 2-4 中的仪表板显示了该季度中段的单个季度的错误预算。 在这里，我们看到单个事件在两天内消耗了大约 15％ 的错误预算。

![image](/book/figure/Figure2-4.png)

图 2-4 错误预算仪表板

错误预算对于量化这些事件非常有用 - 例如，“此次中断消耗了我季度错误预算的 30％”，或者“这些是本季度排名前三的事件，按照他们消耗的误差预算排序”。

### 持续改进 SLO 目标

每一项服务都能从持续改进中受益。例如，这是 [ITIL](https://en.wikipedia.org/wiki/ITIL) 中的中心服务目标之一。

在改进SLO目标之前，需要了解用户对服务的满意度。有很多选择：

- 您可以计算手动发现的停机、公共论坛上的帖子、支持票和呼叫客户服务的次数。

- 你可以尝试在社交媒体上衡量用户的情绪。

- 您可以向系统中添加代码，以定期对用户幸福感进行示例。

- 您可以进行面对面的用户调查和样本。

可能性是无限的，最优的方法取决于您的服务。我们建议从收集成本低廉的度量开始，并从这个起点开始迭代。让你的产品经理在与客户讨论价格和功能时加入可靠性，这是一个很好的开始。

### 提高你的 SLO 的质量

计算您手动检测到的停机。如果你有支持票，也要数一数。查看已知停机或事件的时间段。检查这些周期与错误预算的急剧下降有关。同样，当您的 SLIs 指示出问题，或者您的服务脱离 SLO 时，请查看这些情况。这些时间段是否与已知的停机或支持票的增加有关?如果您熟悉统计分析，那么 [Spearman 的秩相关系数](https://en.wikipedia.org/wiki/Spearman's_rank_correlation_coefficient)可以作为一种有用的方法来量化这种关系。

图 2-5 显示了每天增加的支持票的数量与当天错误预算中测量的损失之间的关系。虽然不是所有的票据都与可靠性问题有关，但票据与错误预算损失之间存在相关性。我们看到两个异常值:一天只有 5 张票，我们损失了 10% 的错误预算;一天有 40 张票，我们没有损失任何错误预算。两者都需要更深入的调查。

![image](/book/figure/Figure2-5.png)

图 2-5 图表显示每天的支持票的数量与当天的预算损失

如果在任何 SLI 或 SLO 中都没有捕捉到您的一些停机和票据峰值，或者如果您有 SLI 下降和 SLO 未映射到用户面临的问题，这是您的 SLO 缺少覆盖率的一个强烈信号。这种情况完全正常，应该预料到。您的 SLIs 和 SLOs 应该随着时间的推移而变化，因为它们所代表的服务的实际情况发生了变化。不要害怕随着时间的推移检查和完善它们!

如果您的 SLO 缺乏覆盖范围，您可以采取多种行动方案：

*修改你的 SLO*

如果您的 SLIs 表明有问题，但是 SLOs 没有提示任何人注意或响应，那么您可能需要收紧 SLO。

- 如果在那个日期发生的事件足够大，需要处理，请查看相关期间的 SLI 值。计算在这些日期，什么 SLO 会导致通知。将该 SLO 应用于您的历史的 SLIs，并查看此调整将捕获哪些其他事件。如果降低了 precision(精度)，使团队必须不断地对不重要的事件作出响应，那么改进系统的 recall<sup>7</sup>是没有意义的。

- 同样，对于[假阳性](https://en.wikipedia.org/wiki/False_positives_and_false_negatives)的日子，考虑放松 SLO

如果在两个方向上更改 SLO 导致太多的假阳性或假阴性，那么您还需要改进 SLI 实现。

> 7 recall 是 SLI 捕捉到的显著影响用户的事件的比例。精度是 SLI 捕获的事件中对用户有显著影响的事件所占的比例

*更改您的 SLI 实现*

有两种方法可以改变您的SLI实现:要么将度量移到更接近用户的地方来改进度量的质量，要么改进覆盖率，从而获得更高比例的用户交互。例如:

- 与其在服务器上测量成功/延迟，不如在负载平衡器或客户端测量。

- 与其使用简单的 HTTP GET请求来度量可用性，不如使用一个健康检查处理程序来检测系统的更多功能，或者使用一个执行所有客户端 JavaScript 的测试。

*建立一个有目标的 SLO*

有时您确定需要更严格的 SLO 来让用户满意，但是改进产品以满足该 SLO 需要一些时间。如果您实现了更严格的 SLO，那么您将永远脱离 SLO，并受制于您的错误预算策略。在这种情况下，您可以使改进的 SLO 成为一个有目标的 SLO，并与当前的 SLO 一起跟踪和度量，但是在错误预算策略中明确指出不需要采取行动。这样你就可以跟踪自己的进展，以达到理想的 SLO，但你不会永远处于紧急状态。

*迭代*

有许多不同的迭代方法，您的评审会议将确定许多潜在的改进。选择投资回报最高的选项。特别是在最初的几个迭代中，错误地倾向于更快更便宜;这样做可以减少度量中的不确定性，并帮助您确定是否需要更昂贵的度量。需要迭代多少次就迭代多少次。

## 使用 SLOs 和错误预算进行决策

一旦你有了 SLOs，你就可以开始使用它们来做决策。

最明显的决定开始于当你没有达到你的SLO时，也就是当你耗尽了你的错误预算时，你该做什么。正如已经讨论过的，当您耗尽错误预算时，错误预算策略应该包括适当的操作过程。常见的策略包括停止特性启动，直到服务再次在 SLO 中运行，或者将部分或全部工程时间用于处理与可靠性相关的 bug。

在极端情况下，团队可以在获得高层批准的情况下宣布紧急状态，以取消所有外部需求(例如来自其他团队的请求)，直到服务满足退出标准——通常是服务在 SLO 中，并且您已经采取了步骤来减少后续 SLO 失败的机会。这些步骤可能包括改进监视、改进测试、删除危险的依赖项，或者重构系统以删除已知的故障类型。

您可以根据所消耗的错误预算的比例来确定事件的规模，并使用这些数据来识别最需要进一步调查的关键事件。

例如，假设一个新的 API 版本的发布会导致 100% 的NullPointerExceptions ，直到四个小时后系统可以被恢复<sup>8</sup>。检查原始服务器日志表明，这个问题导致了 14066 个错误。使用前面 97% 的 SLO 数据和 109,897 个错误的预算，这个事件使用了 13% 的错误预算。

> 8 这里值得重申的是，错误预算是用户满意度的近似值。每30天一次4小时的停机可能会比每30天4次单独的1小时停机导致更少的不满意用户，这反过来又会比0.5%的恒定错误率导致更少的不满意用户，但是我们的错误预算对他们一视同仁。这些阈值在不同的服务之间会有所不同。

或者可能存储我们的单独归属状态数据库的服务器失败，从备份恢复需要20个小时。我们估计（根据该时期的历史流量）此次中断导致我们 72,000 个错误，或我们的错误预算的 65％。想象一下，我们的示例公司在五年内只有一个服务器故障，但通常会遇到两到三个需要每年回滚的坏版本。我们可以估计，平均而言，糟糕的推送成本是数据库故障的两倍。这些数字证明，解决发布问题比调查服务器故障时投入资源提供了更多好处。

如果服务运行完美且几乎不需要监督，那么可能是时候将服务转移到一个不太亲力亲为的支持层。 您可能会继续提供事件响应管理和高级别监督，但您不再需要在日常工作中密切参与产品。 因此，您可以将精力集中在需要更多 SRE 支持的其他系统上。

表 2-5 提供了基于三个关键维度的建议行动方案：

- 针对 SLO 的性能

- 运营服务所需的工作量

- 客户对服务的满意程度

*表 2-5 SLO决策矩阵*

![image](/book/figure/Table2-5.png)

## 高级主题

一旦您拥有健康，成熟的SLO和错误预算文化，您就可以继续改进和完善测量和讨论服务可靠性的方式。

### 模拟用户旅程

虽然本章中讨论的所有技术都将有益于您的组织，但最终 SLO 应该以改善客户体验为中心。 因此，您应该以用户为中心的操作来编写 SLO。

您可以使用关键用户旅程来帮助捕获客户的体验。 关键用户旅程是一系列任务，是给定用户体验的核心部分，也是服务的一个重要方面。 例如，对于在线购物体验，关键用户旅程可能包括：

- 搜寻产品

- 把产品加入购物车

- 完成购买

这些任务几乎肯定不能很好地匹配您现有的 SLI; 每个任务都需要多个复杂的步骤，这些步骤可能在任何时候都会失败，并且从日志中推断这些操作的成功（或失败）可能非常困难。 （例如，您如何确定用户是否在第三步失败，或者他们是否只是被另一个标签中的猫视频分心？）但是，在开始确保服务方面可靠之前，我们需要确定对用户重要的内容。

一旦识别出以用户为中心的事件，就可以解决测量它们的问题。 您可以通过将不同的日志事件连接在一起，使用高级 JavaScript 探测，使用客户端检测或使用其他一些过程来测量它们。 一旦您可以衡量一个事件，它就变成了另一个 SLI，您可以跟踪现有的 SLI 和 SLO。 关键用户旅程可以在不影响精确度的情况下改善您的 recall。

### 评分交互重要性

并非所有请求都被视为平等。 来自移动应用程序的 HTTP 请求会检查帐户通知（通知由每日管道生成）对您的用户非常重要，但不如广告客户的与结算相关的请求重要。

我们需要一种方法来区分某些类别的请求。 您可以使用 *分类* 来完成此操作 - 也就是说，为SLI添加更多标签，然后将不同的 SLO 应用于这些不同的标签。 表 2-6 显示了一个示例。

*表 2-6 按层次划分*

![image](/book/figure/Table2-6.png)

您可以按预期的响应速度拆分请求，如表 2-7 所示。

*表 2-7 以预期的响应能力进行划分*

![image](/book/figure/Table2-7.png)

如果您有可用于将 SLO 单独应用于每个客户的数据，则可以在任何给定时间跟踪 SLO 中的客户数量。 请注意，这个数字可能变化很大 - 发送数量非常少的客户将获得100％的可用性（因为他们很幸运，没有经历过任何故障）或者可用性非常低（因为他们遇到的一次失败是他们要求的很大一部分）。 由于无趣的原因，个别客户无法满足他们的 SLO，但总体而言，跟踪影响大量客户 SLO 合规性的问题可能是一个有用的信号。

### 建模依赖关系

大型系统有许多组件。 单个系统可以具有表示层，应用层，业务逻辑层和数据持久层。 这些层中的每一层可以由许多服务或微服务组成。

虽然您首要关注的是实现覆盖整个堆栈的以用户为中心的 SLO，但 SLO 也可以成为协调和实现堆栈中不同组件之间可靠性要求的有用方法。

例如，如果单个组件是特定高价值交互的关键依赖关系<sup>9</sup>，则其可靠性保证应至少与从属操作的可靠性保证一样高。 运行该特定组件的团队需要以与总体产品 SLO 相同的方式拥有和管理其服务的 SLO。

> 9 如果依赖性不可用意味着您的服务也不可用，则依赖性至关重要。

如果某个特定组件具有固有的可靠性限制，则 SLO 可以通信该限制。 如果依赖于它的用户旅程需要比组件可以合理提供的更高级别的可用性，则需要围绕该条件进行工程设计。 您可以使用其他组件或添加足够的防御（缓存，脱机存储转发处理，优雅降级等）来处理该组件中的故障。

尝试数学解决这些问题的方法很诱人。 如果您的服务在单个区域中提供 99.9％ 的可用性，并且您需要 99.95％ 的可用性，那么只需在两个区域中部署服务即可解决该要求。两种服务同时出现中断的可能性非常低，因此两个区域应提供 99.9999％ 的可用性。 然而，这种推理假设两种服务都是完全独立的，几乎从来不是这种情况。 您的应用程序的两个实例将具有公共依赖关系，常见故障域，共享命运和全局控制平面 - 所有这些都可能导致两个系统中断，无论其设计和管理多么谨慎。 除非仔细列举和考虑这些依赖关系和失败模式中的每一个，否则任何此类计算都将具有欺骗性。

当失败是由另一个团队处理的依赖引起时，有两种思路可以解决错误预算策略应如何解决错过的 SLO：

- 您的团队不应停止发布或将更多时间用于可靠性，因为您的系统不会导致问题。

- 您应该制定更改冻结，以便最大程度地降低未来中断的可能性，无论中断的原因如何。

第二种方法将使您的用户更快乐。 您在如何应用此原则方面具有一定的灵活性。 根据中断和依赖性的性质，冻结变化可能不切实际。 确定最适合您的服务及其依赖关系的内容，并在您记录的错误预算中记录后代的决定。 有关这在实践中如何工作的示例，请参阅附录B中的示例错误预算策略。

### 尝试放宽您的 SLOs

您可能希望尝试应用程序的可靠性并测量可靠性的哪些变化（例如，将延迟添加到页面加载时间）对用户行为（例如，完成购买的用户的百分比）具有可测量的负面影响。 我们建议仅在您确信要刻录错误预算时才执行此类分析。 延迟，可用性，客户，业务领域和竞争（或缺乏竞争）之间存在许多微妙的相互作用。 要做出选择以故意降低感知的客户体验，要像 Rubicon（卢比肯）一样必须非常仔细地交叉思考，如果有的话。

虽然这个练习可能看起来很可怕（没有人想要失去销售！），但通过执行此类实验可以获得的知识将使您能够以更好的性能（以及更高的销售额！）来改善您的服务。 该过程可以允许您在数学上识别关键业务度量（例如，销售）与可测量技术度量（例如，等待时间）之间的关系。 如果是这样，您可以获得非常有价值的数据，您可以使用这些数据为您的服务做出重要的工程决策。

这项工作不应该是一次性活动。 随着您的服务不断发展，客户的期望也将随之提升。 确保定期检查关系的持续有效性。

这种分析也存在风险，因为您可能会误解所获得的数据。 例如，如果您将页面人为地减慢了 50 ms ，并注意到转换中没有相应的丢失，您可能会得出结论，您的延迟 SLO 过于严格。 但是，您的用户可能不满意，但目前只缺少您的服务替代方案。 一旦竞争对手出现，您的用户就会离开。 确保您正在测量正确的指示器，并采取适当的预防措施。

### 结论

本书中涉及的每个主题都可以与 SLO 联系起来。 现在您已经阅读了本章，我们希望您同意，即使部分正式化的 SLO（明确说明您对用户的承诺）也提供了一个框架，可以更清晰地讨论系统行为，并有助于在服务失败时查明可操作的补救措施以满足期望。

总结一下：

- SLOs 是衡量服务可靠性的工具。

- 错误预算是平衡可靠性与其他工程工作的工具，也是决定哪些项目影响最大的好方法。

- 您应该立即开始使用 SLO 和错误预算。

有关示例SLO文档和示例错误预算策略，请参阅附录
 A 和 B。
 