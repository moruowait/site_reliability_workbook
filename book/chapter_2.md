# chapter 2  实现 SLOs

服务级别目标(SLOs)为服务的可靠性指定一个目标级别。因为SLOs是关于可靠性的数据驱动决策的关键，所以它们是SRE实践的核心。从很多方面来说，这是本书最重要的一章。

一旦您具备了一些指导原则，就可以直接设置初始SLOs和细化它们的过程。第4章介绍了SLOs和SLIs (service level indicators，服务水平指标)的主题，并就如何使用给出了一些建议。

在讨论了SLOs背后的动机和错误预算之后，本章提供了一个循序渐进的方法来帮助您开始思考 SLOs，以及一些关于如何从那里迭代的建议。然后我们将介绍如何使用SLOs来做出有效的业务决策，并探讨一些高级主题。最后，我们将为您提供一些用于不同类型服务的 SLOs 示例，以及一些关于如何在特定情况下创建更复杂 SLOs 的方针。

> 关于术语的注意事项:在本章中，我们使用可靠性这个词来讨论服务在所有 sla 方面的执行情况。这可以指示许多事情，例如可用性或延迟。

## 为什么 SREs 需要 SLOs

即使在最大的组织中，工程师也是一种稀缺的资源。工程时间应该投资在最重要的特征最重要的服务上。在投资于能够赢得新客户或保留现有客户的功能和投资于能够让这些客户满意的可靠性和可伸缩性之间取得适当的平衡是困难的。在谷歌，我们了解到，一个经过深思熟虑并采用的SLO是关于可靠性工作的机会成本做出基于数据的决策，以及确定如何适当地对该工作进行优先排序的关键。

SREs 的核心职责不仅仅是实现“所有事情”的自动化和手持寻呼机。它们的日常任务和项目由 SLOs 驱动:确保 SLOs 在短期内得到保护，并且可以在中长期内得到维护。甚至可以说，没有 SLOs，就不需要 SREs。

SLOs是一种工具，可以帮助确定工程工作的优先级。例如，考虑两个可靠性项目的工程权衡:自动回滚和迁移到可复制的数据存储。通过计算对错误预算的估计影响，我们可以确定哪个项目对用户最有利。参见第37页的“使用SLOs和错误预算进行决策”一节，了解更多关于此的细节，以及站点可靠性工程中的“风险管理”。

## 开始

作为建立一组基本 SLOs 的起点，让我们假设您的服务是某种已编译和发布的代码，并且运行在用户通过 web 访问的网络基础设施上。您的系统的成熟度级别可能是以下级别之一:

- 一个新开发的领域，目前没有部署任何东西

- 在生产环境中，有一些监控系统，当出现问题时通知您，但是没有正式的目标，没有错误预算的概念，也没有100%正常运行时间的默认目标

- 在 SLO 低于 100% 的情况下运行的部署，但是对于其重要性或如何利用它进行持续改进的选择没有一个共同的理解——换句话说，一个没有牙齿的 SLO。

为了采用基于错误预算的方法进行现场可靠性工程，您需要达到以下状态:

- 组织中的所有涉众都批准了适合产品的 SLOs。

- 负责确保服务符合其SLO的人员同意，在正常情况下有可能符合该 SLO。

- 组织已经承诺将错误预算用于决策和优先级排序。这一承诺在错误预算政策中得到正式体现。

- 有一个提炼 SLO 的过程。

否则，您将无法采用基于错误预算的可靠性方法。SLO 遵从性将仅仅是另一个 KPI (关键性能指标)或报告度量，而不是决策工具。

## 可靠性目标和错误预算

制定适当的 SLOs 的第一步是讨论什么是 SLO，以及它应该包括什么。

SLO 为服务的客户设置了一个可靠的目标级别。在此阈值之上，几乎所有用户都应该对您的服务感到满意(假设他们对服务的实用程序感到满意)。在这个阈值以下，用户可能会开始抱怨或停止使用该服务。最终，用户的快乐才是最重要的——快乐的用户使用服务，为您的组织创造收入，对客户支持团队提出低要求，并向他们的朋友推荐服务。我们以可靠的服务使顾客满意。

顾客幸福感是一个相当模糊的概念;我们不能精确地测量它。通常我们对它的了解很少，那么我们该如何开始呢?第一个 SLO 使用什么?

我们的经验表明，100% 的可靠性是错误的目标。

- 如果您的 SLO 与客户满意度一致，那么100%不是一个合理的目标。即使使用冗余组件、自动健康检查和快速故障转移，一个或多个组件同时失败的概率也不为零，从而导致不足 100% 的可用性。

- 即使您可以在系统中实现 100% 的可靠性，您的客户也不会体验到 100% 的可靠性。您和您的客户之间的系统链通常又长又复杂，这些组件中的任何一个都可能失败。这也意味着，当可靠性从 99% 提高到 99.9% 再提高到 99.99% 时，每增加 9 个，成本就会增加，但客户的边际效用会稳步接近于零。

- 如果你设法为你的客户创造一种 100% 可靠的体验，并且想要保持这种可靠程度，你就永远无法更新或改进你的服务。停机的首要原因是更改:推出新功能、应用安全补丁、部署新硬件，以及扩大规模以满足客户需求，这些都将影响到100%的目标。迟早，你的服务将停滞不前，你的客户将转向别处，这对任何人的底线都不是好事。

- SLO 为 100% 意味着您只有时间进行响应。除了对 < 100% 可用性(这是肯定会发生的)作出反应之外，您实际上不能做任何其他事情。100% 的可靠性不是一种工程文化，而是一种运维文化。

- 一旦您的 SLO 目标低于 100%，这就需要组织中有权在特性速度和可靠性之间进行权衡的人员。在小型组织中，这可能是 CTO，在较大的组织中，通常是产品所有者（或产品经理）。

## 怎么来衡量：使用 SLIs（服务水平指标）

一旦你同意100%是错误的数字，你如何确定正确的数字?你到底在测量什么?这里，服务水平指示器开始发挥作用:SLI 是您所提供服务水平的指示器。

虽然很多数字都可以作为 SLI。我们通常建议将两个数字的比值作为 SLI：好的事件除以事件的总数。例如：

- HTTP请求成功次数/ HTTP请求总数(成功率)

- < 100 ms / total gRPC请求中成功完成的gRPC调用数

- 使用整个语料库的搜索结果的数量/搜索结果的总数，包括那些优雅地降级的搜索结果

- 产品搜索中使用的库存数据更新时间超过10分钟的“库存盘点”请求数量/库存盘点请求总数

- 根据该度量标准的扩展标准列表，“良好用户分钟”的数量/总用户分钟数

这种形式的 SLIs 具有几个特别有用的属性。SLI 范围从 0% 到100%，0% 表示什么都不行，100% 表示什么都没有损坏。我们发现这个比例很直观，而且这种风格很容易引入错误预算的概念:SLO 是一个目标百分比，错误预算是 100% 减去 SLO。例如，如果您有 99.9% 的成功率 SLO，那么在四周时间内接收 300 万请求的服务在此期间的预算错误为 3000(0.1%)。如果一次停机造成 1500 个错误，那么该错误将花费错误预算的 50%。（如果你在一个日历周期(比如四分之一年)内测量你的SLO，那么如果你的预算是基于不可预测的指标(比如流量)，那么你可能不知道在这个季度末你的预算会有多大。有关报告期间的更多讨论，请参阅第29页的“选择适当的时间窗口”。）

此外，使所有的 SLIs 遵循一致的风格可以更好地利用工具:您可以编写警报逻辑、SLO 分析工具、错误预算计算和报告，以期望得到相同的输入:分子、分母和阈值。简化是这里的一个好处。

当您第一次尝试制定 SLIs 时，您可能会发现将 SLIs 进一步划分为 SLI 规范和 SLI 实现是非常有用的。

SLI 规范
    
与如何测量无关，你认为服务结果的评估对用户很重要

例如：载入事件小于 100ms 的主页请求的比率

SLI 实现

规范 SLI 及测量它的方法。

例如：

- 从服务器日志的延迟这一列指标测量的以< 100 ms装载的主页请求的比率。此度量将错过未能到达后端的请求。

- 加载在< 100毫秒内的主页请求的比率，由在虚拟机中运行的浏览器中执行JavaScript的探测程序测量。当请求无法到达我们的网络时，这种度量将捕获错误，但是可能会遗漏只影响一部分用户的问题。

- 加载在< 100ms内的主页请求的比率，通过在主页本身的JavaScript中的检测来衡量，并报告给专用的遥测记录服务。这种度量将更准确地捕获用户体验，尽管我们现在需要修改代码来捕获这些信息，并构建基础设施来记录它——这是一种具有自身可靠性需求的规范。

正如您所看到的，一个规范可能有多个 SLI 实现，每个实现在质量(它们捕获客户体验的精确性)、覆盖率(它们捕获所有客户体验的精确性)和成本方面都有自己的优缺点。

你对 SLI 和 SLO 的第一次尝试不一定是正确的;最重要的目标是让一些东西到位并得到衡量，并建立一个反馈循环，这样你就可以改进。(我们在第34页的“SLO目标的持续改进”中对此主题进行了更深入的探讨。)

在我们的第一本书中，我们建议不要基于当前的性能选择一个 SLO，因为这会使您陷入不必要的严格的SLOs。虽然这个建议是正确的，但是如果您没有任何其他信息，并且您有一个很好的迭代过程(我们将在稍后介绍)，那么您当前的性能可能是一个很好的起点。然而,不要让当前的性能限制你完善你的 SLO:你的客户也会期待你的服务来执行 SLO,所以如果你的服务返回成功请求 99.999% 的时间不到 10ms,任何从基线重要的回归可能让他们不开心。

为了创建您的第一组 SLOs，您需要决定一些与您的服务相关的关键 SLI 规范。可用性和延迟 SLOs 是很常见的：新鲜度、持久性、正确性、质量和覆盖率 SLOs 也有它们的位置(稍后我们将详细讨论这些)。

如果您在确定从哪种类型的 SLI 开始时有困难，那么从简单的开始会有所帮助:

- 选择要为其定义SLOs的应用程序。如果您的产品包含许多应用程序，您可以稍后添加这些应用程序。

- 弄清楚这种情况下谁是真正的用户，这些人很乐于看到你这在优化。

- 考虑用户和系统常见任务和关键活动交互的通常方式

- 绘制系统的高层架构图;显示关键组件、请求流、数据流和关键依赖项。将这些组件分组到下一节列出的类别中(可能存在一些重叠和歧义;运用你的直觉，不要让完美成为好的敌人。

您应该仔细考虑选择什么作为您的 SLIs，但也不应该将事情复杂化。特别是当您刚刚开始您的 SLI 之旅时，请选择一个与您的系统相关但易于度量的方面—您总是可以在稍后进行迭代和改进。

## 组件的类型

开始设置 SLIs 最简单的方法是将系统抽象为几种常见类型的组件。然后，您可以使用我们为每个组件提供的建议 SLIs 列表，选择与您的服务最相关的组件:

需求驱动

用户创建某种类型的事件并期望得到响应。例如，这可以是一个HTTP服务，用户可以在其中与浏览器或移动应用程序的API交互。

管道

将记录作为输入、对记录进行改变并将输出放到其他地方的系统。这可能是一个实时运行在单个实例上的简单进程，也可能是一个耗时数小时的多阶段批处理进程。例子包括：

- 一种定期从关系数据库中读取数据并将其写入分布式哈希表以便优化服务的系统

- 一种视频处理服务，将视频从一种格式转换为另一种格式

- 从多个源读取日志文件以生成报告的系统

- 从远程服务器获取指标并生成时间序列和警报的监视系统

存储

一种接受数据(如字节、记录、文件、视频)并使之在以后能够被检索的系统。

## 一个生动的例子

考虑一个简化的手机游戏架构，如图2-1所示。

![image](/book/figure/Figure2-1.png)